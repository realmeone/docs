# RO消息传输​​协议

## 目的

RO消息传输协议（RO message transfer protocol = ROMTP）是用于传输RO网络内部消息的基于TCP/IP的应用层协议。主要的应用场景在RO网络的P2P节点之间的传输。节点服务的默认端口为50500。我们希望通过ROMTP，能够使得RO网络的P2P节点能够快速的共享消息，提升消息处理速度，从而提升整个P2P节点的效率。当然，我们秉承开放心态，希望大家积极帮助我们改进优化协议，同时也能基于ROMTP扩展出更多更好更优秀的P2P消息传输协议。

## 定义

### 网络（Network）

是一种消息拓扑结构，每个节点与所有的节点之间都可以存在连接，从宏观上看起来就像一个网状结构。

### 连接（Connection）

指两个节点之间为了通信而打开一条虚拟的传输通道。

### 节点（Peer）

我们将一个网络中的终端成为一个节点。节点可以发送和收取消息。

### 消息（Message）

通信的基本单元，一个消息包含了消息版本、消息类型、内容校验码、内容类型、内容长度和内容。

| 名称 | 字节 | 类型 | 是否必须| 描述 |
| - | - | - | - | - |
| Version | 4 | Int | 是 | 消息的版本，默认是1 |
| Type | 4 | Int | 是 |消息类型，例如Hello、Ping、Pong，默认是hello |
| Content-Checksum | 4 | ByteArray | 否 | 内容的校验码，为内容的sha256两次的前4个字节 |
| Content-Type | 4 | Int | 否 | 内容的类型，例如binary代表二进制，text代表文本， protobuf代表了protobuf进行的编码，默认是protobuf |
| Content-Length | 4 | Int | 否 | 内容的字节长度 |
| Content | ? | ByteArray | 否 | 内容 |

一个消息的二进制范例（注意：这不是一个真实的范例，而只是一个说明）：

```text
| 00 00 00 01 | 00 00 00 00 | 11,22,33,44 | 00 00 00 00 | 00 00 00 01 | 00 01 00 01 00 ... |
```

如果一条消息没有校验码，即是只有消息版本和消息类型，则后续内容不会进行解析。这样的消息我们称之为静态消息，反之为动态消息。通常的静态消息有Hello，Ping，Pong等。

#### 内容类型

消息的内容默认采用的是Protobuf进行串行化。节点之间也可以定义不同的串行算法，但是，如果节点不能识别当前串行算法，则会丢弃该信息。

### 请求和响应（Request & Response）

消息分为请求和响应两种，每次一个节点向另外一个节点发出请求，另外一个节点必须回复响应，除非这个节点发出的请求是不需要回复的（例如关闭连接请求）。

除了几种特殊消息以外，通常请求消息名称都已"Get_"前缀，响应消息则一般为请求消息名去掉"Get_"前缀的名称。例如："Get_Time" -> "Time"。

### 超时（Timeout）

单个节点的超时时间设置在60秒，即60秒没有响应，则将会放弃该节点。

### 最大消息

单个消息的大小不能超过32M。

## 消息类型

### Hello

当一个节点连接到另外一个节点的时候，会发送Hello信息到另外一个节点，另外一个节点将会回应Info消息，告知这个节点相应的情况。

### Disconnect

当PeerClient要离开一个PeerServer的时候，会发送Disconnect信息到PeerServer，PeerServer接收到消息将会直接关闭通道，所以在发送这个消息之后不要尝试再次发送其他消息，将会出现连接拒绝、通道关闭等类似错误。

### Ping

发送ping消息主要是为了确认TCP/IP连接仍然有效。如果返回消息不正确（不为Pong）、出现超时或者任何一个错误信息，则认定当前对等节点已经失效，并在当前对等节点列表中被降级或者移除。

### Pong

Pong消息是对Ping消息的回应。

### Get_Time

发送此消息是为了获取当前PeerServer的时间信息。

### Time

此消息为Get_Time的响应消息，返回当前PeerServer的秒级时间，从1970/1/1 00:00:00开始计算。

### Get_Peers

PeerClient为了获取当前PeerServer所知的所有对等节点的信息而发送此消息。

### Peers

Peers是对Get_Peers消息的回应。返回当前节点所存储的所有对等节点，以及对这些节点的评分。