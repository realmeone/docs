# P2P 网络

RO网络协议允许对等节点协作维护对等网络以交换区块和交易。对等节点验证区块和交易，并将它们传输到其他节点。有的对等节点存储了整个区块链，可以将历史区块提供给其他节点。有的对等节点不存储整个区块链，而只存储区块头。

## 定义

| 名称 | 描述 |
| - | - |
| 网络（Network） | 是一种消息拓扑结构，每个节点与所有的节点之间都可以存在连接，从宏观上看起来就像一个网状结构 |
| 节点（Peer） | 我们将一个网络中的终端成为一个节点。节点可以发送和收取消息 |
| 连接（Connection） | 指两个节点之间为了通信而打开一条虚拟的传输通道 |
| 消息（Message） | 通信的基本单元 |

## 连接到对等节点

当本地节点连接到远程节点时，本地节点主动发送握手消息（Handshake）到远程节点，握手消息包含了节点当前的信息，远程节点回应握手消息，双方交换了握手消息之后，便建立了连接通道。

节点之间建立连接之后，为了维持双方的连接，默认情况下，节点会在30分钟不活动时发送Ping消息，如果60分钟不活动，则会发送Disconnect消息之后关闭连接。

## 网络版本

| 版本 | 描述 |
| - | - |
| 0x01 | 第一个版本 |

## 消息（Message）

网络协议中的所有消息都使用相同的格式。

| 字段 | 类型 | 字节 | 描述 |
| - | - | - | - |
| network | int32 | 4 | 网络 |
| version | int32 | 4 | 协议版本 |
| type | enum | 4 | 消息类型 |
| payload | bytes | * | 载荷 |

消息采用了Protobuf进行编码和解码。

## 消息数据

消息数据描述了所有交换的数据内容。

|  |  |  |
| - | - | - |
|shakehand| <------------> |shakehand|
|ping| <------------> |pong|
|getBlocks| <------------> |blocks|
|getTxs|     <------------> |txs|
|getPeers|     <------------> |peers|

## Shakehand

握手消息。

节点双方在握手消息交换之前，发送任何其他消息，都会得到远程节点的Disconnect消息，并被远程关闭连接。

## Disconnect

当节点要关闭通道的时候，会发送Disconnect信息到对等节点，对等节点接收到消息将会直接关闭通道，所以在发送这个消息之后不要尝试再次发送其他消息，将会出现连接拒绝、通道关闭等类似错误。

## Ping

发送ping消息主要是为了确认TCP/IP连接仍然有效。如果返回消息不正确（不为Pong）、出现超时或者任何一个错误信息，则认定当前对等节点已经失效，并在当前对等节点列表中被降级或者移除。

## Pong

Pong消息是对Ping消息的回应。

## Get_Time

发送此消息是为了获取当前PeerServer的时间信息。

## Time

此消息为Get_Time的响应消息，返回当前PeerServer的秒级时间，从1970/1/1 00:00:00开始计算。

## GetPeers

节点为了获取远程节点所知的所有对等节点的信息而发送此消息。

## Peers

Peers是对Get_Peers消息的回应。返回当前节点所存储的所有对等节点，以及对这些节点的评分。